<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VividQR Generator</title>
    <!-- 
      This link works because Flask is configured to serve static files 
      from the same folder where this index.html file is located.
    -->
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <main class="card">
        <h1>âœ¨ VividQR Generator</h1>
        <p>Choose your QR type, customize, and generate.</p>

        <form id="qr-form">
            <!-- Feature 2: QR Type Selector -->
            <div class="input-group">
                <label for="qr-type">QR Code Content</label>
                <select id="qr-type" name="qr-type">
                    <option value="wifi">ðŸ“¶ WiFi Network</option>
                    <option value="url">ðŸ”— Website URL</option>
                    <option value="text">ðŸ“„ Plain Text</option>
                </select>
            </div>

            <!-- WiFi Fields (default) -->
            <div id="wifi-fields" class="type-fields">
                <div class="input-group">
                    <label for="ssid">Network Name (SSID)</label>
                    <input type="text" id="ssid" name="ssid" required>
                </div>
                <div class="input-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" placeholder="Leave blank for open network">
                </div>
            </div>

            <!-- URL Fields (hidden) -->
            <div id="url-fields" class="type-fields hidden">
                <div class="input-group">
                    <label for="url">Website URL</label>
                    <input type="url" id="url" name="url" placeholder="e.g., google.com" required>
                </div>
            </div>

            <!-- Text Fields (hidden) -->
            <div id="text-fields" class="type-fields hidden">
                <div class="input-group">
                    <label for="text">Your Text</label>
                    <textarea id="text" name="text" rows="3" placeholder="Enter any text..." required></textarea>
                </div>
            </div>

            <!-- Feature 3: Color Pickers -->
            <div class="color-picker-group">
                <div class="input-group">
                    <label for="fill-color">Code Color</label>
                    <input type="color" id="fill-color" name="fill-color" value="#000000">
                </div>
                <div class="input-group">
                    <label for="bg-color">Background</label>
                    <input type="color" id="bg-color" name="bg-color" value="#FFFFFF">
                </div>
            </div>
            
            <button type="submit" id="generate-btn">Generate QR</button>
        </form>

        <!-- The generated QR code and download button will appear here -->
        <div id="qr-result" class="hidden">
            <img id="qr-image" alt="Generated QR Code">
            <!-- Feature 1: Download Button -->
            <a href="#" id="download-btn" class="button-download" download="qrcode.png">
                Download QR
            </a>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- ELEMENT REFERENCES ---
            const form = document.getElementById('qr-form');
            const button = document.getElementById('generate-btn');
            const qrResultDiv = document.getElementById('qr-result');
            const qrImage = document.getElementById('qr-image');
            const qrTypeSelect = document.getElementById('qr-type');
            const downloadBtn = document.getElementById('download-btn');
            
            const fieldGroups = {
                wifi: document.getElementById('wifi-fields'),
                url: document.getElementById('url-fields'),
                text: document.getElementById('text-fields')
            };

            // --- FUNCTION TO MANAGE FORM FIELDS VISIBILITY ---
            function updateFormFields() {
                const selectedType = qrTypeSelect.value;
                // Hide all field groups first
                Object.values(fieldGroups).forEach(group => group.classList.add('hidden'));
                
                // Disable 'required' attribute on all inputs
                Object.values(fieldGroups).forEach(group => {
                    group.querySelectorAll('input, textarea').forEach(input => input.required = false);
                });

                // Show the selected group and make its inputs required
                if (fieldGroups[selectedType]) {
                    fieldGroups[selectedType].classList.remove('hidden');
                    fieldGroups[selectedType].querySelectorAll('input, textarea').forEach(input => {
                        // The WiFi password is not required, so we skip it
                        if (input.id !== 'password') {
                            input.required = true;
                        }
                    });
                }
            }

            // --- EVENT LISTENERS ---
            // 1. Listen for changes on the dropdown to show/hide fields
            qrTypeSelect.addEventListener('change', updateFormFields);

            // 2. Listen for the main form submission
            form.addEventListener('submit', async (event) => {
                event.preventDefault(); // Stop the page from reloading
                
                // Provide user feedback
                button.textContent = 'Generating...';
                button.disabled = true;

                // Build the data payload to send to the Python backend
                const qr_type = qrTypeSelect.value;
                const payload = {
                    qr_type: qr_type,
                    fill: document.getElementById('fill-color').value,
                    bg: document.getElementById('bg-color').value
                };

                if (qr_type === 'wifi') {
                    payload.ssid = document.getElementById('ssid').value;
                    payload.password = document.getElementById('password').value;
                } else if (qr_type === 'url') {
                    payload.url = document.getElementById('url').value;
                } else if (qr_type === 'text') {
                    payload.text = document.getElementById('text').value;
                }

                try {
                    // Send the data to our Flask backend using the Fetch API
                    const response = await fetch('/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        // If the server returned an error, show it
                        throw new Error(data.error || 'An unknown error occurred.');
                    }
                    
                    // Update the image source and download link with the received data
                    qrImage.src = data.qr_image_uri;
                    downloadBtn.href = data.qr_image_uri;
                    
                    // Show the result section
                    qrResultDiv.classList.remove('hidden');

                } catch (error) {
                    console.error('Error:', error);
                    alert(`Could not generate QR code: ${error.message}`);
                } finally {
                    // Restore the button state
                    button.textContent = 'Generate QR';
                    button.disabled = false;
                }
            });

            // --- INITIALIZATION ---
            // Set the correct form fields when the page first loads
            updateFormFields();
        });
    </script>
</body>
</html>
